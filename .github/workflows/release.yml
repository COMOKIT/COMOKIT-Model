name: Release CI master

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: master
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '0 0 * * *' #every day

defaults:
  run:
    shell: bash
    
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      
    - name: Move COMOKIT under single folder
      run: mkdir COMOKIT && find . -maxdepth 1 -not -name ".*" | grep -v COMOKIT| xargs -i mv {} ./COMOKIT
      
    - name: Get latest GAMA Continuous version download url
      run: echo ::set-env name=GAMA_URL::$(docker run enflo/curl-action -s https://api.github.com/repos/gama-platform/gama/releases/tags/continuous | grep  continuous/GAMA1.8_Continuous_Linux | cut -d ":" -f 2,3 | tr -d \")
    
    - name: Check $GAMA_URL
      run: echo $GAMA_URL
    
    - name: Download GAMA
      run: wget -O gama.zip $GAMA_URL
    
    - name: Extract GAMA Continuous
      run: unzip gama.zip -d $GITHUB_WORKSPACE/GAMA && rm gama.zip && chmod +x GAMA/headless/gama-headless.sh

    - name: Get COMOKIT ToolKit
      run: git clone https://github.com/COMOKIT/COMO-TK.git
      
    - name: Check workspace content
      run: ls -lah $GITHUB_WORKSPACE/*
      
    - name: Compress release
      run: zip -r COMOKIT.zip $GITHUB_WORKSPACE/COMOKIT $GITHUB_WORKSPACE/GAMA $GITHUB_WORKSPACE/COMO-TK
        
    - name: Action Release
      uses: softprops/action-gh-release@v1
      with:
        # Note-worthy description of changes in release
        #body: "Latest version of COMOKIT bundled with GAMA Continuous w/o JDK and COMO-TK" # optional
        # Path to load note-worthy description of changes in release from
        #body_path: # optional
        # Gives the release a custom name. Defaults to tag name
        name: Latest version # optional
        # Creates a draft release. Defaults to false
        #draft: # optional
        # Identify the release as a prerelease. Defaults to false
        prerelease: true # optional
        # Newline-delimited list of path globs for asset files to upload
        files: COMOKIT.zip # optional
        tag_name: master
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN_ROIARTHURB }}
